---
title: "Introduction to BMEmapping"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to BMEmapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

The Bayesian Maximum Entropy (BME) framework offers a robust and versatile approach for space-time data analysis and uncertainty quantification. By integrating principles from Bayesian statistics and the maximum entropy formalism, BME enables the construction of optimal estimates for spatial or spatiotemporal processes in the presence of both precise (hard) and imprecise (soft) data. While hard data correspond to exact point-value measurements, soft data may take the flexible forms of intervals, probability distributions, or qualitative descriptors, making BME particularly well-suited for complex real-world datasets.

The **BMEmapping** R package provides a user-friendly implementation of core BME methodologies, facilitating geostatistical modeling, prediction, and data fusion. It allows for a systematic integration of heterogeneous data sources, incorporates prior knowledge, and supports variogram-based spatial modeling—essential tools for accurate and interpretable spatial interpolation.

Specifically, **BMEmapping** is designed to perform spatial interpolation at unobserved locations using both hard and soft-interval data. This vignette introduces the fundamental functionality of the package and guides users through its basic usage.

To begin, load the package with:

```{r setup}
library(BMEmapping)
```


## Main Functions

The main functions available in **BMEmapping** include:

`prob_zk` - computes and optionally plots the posterior density estimate at a single unobserved location.

`bme_predict` - predicts the posterior mean or mode and the associated variance at an unobserved location.

`bme_cv` - performs a cross-validation on the hard data to assess model performance.


$~$

## A Data Example

To introduce the functionality of **BMEmapping**, we will look at a modeling problem for estimating reliability-targeted snow loads in the state of Utah. The `utsnowload` data that is part of the package and can be accessed by the command

```{r}
data("utsnowload")
head(utsnowload)
```

The variables `latitude` and `longitude` represent the geographic coordinates of each location. The variable `hard` contains the values of precise (hard) data measurements, while `lower` and `upper` define the bounds of the soft interval data. 

Complete documentation for the `utsnowload` dataset can be accessed using the command 

```{r eval=FALSE}
?utsnowload
```

  
### Input Requirements

The **BMEmapping** functions require the following input arguments:

`x`: A matrix specifying the geographic location(s) where predictions are to be made.

`ch`: A matrix or data frame containing the geographic coordinates of the hard data locations.

`cs`: A matrix or data frame containing the geographic coordinates of the soft-interval data locations.

`zh`: A vector of observed hard data values corresponding to the locations in `ch`.

`a`: A vector of lower bounds for the soft-interval data at locations `cs`.

`b`: A vector of upper bounds for the soft-interval data at locations `cs`.

### Variography

Before using `BMEmapping`, the user must fit a variogram model to the spatial data. This step involves specifying the type of variogram and its associated parameters:

* `model`: The variogram model type. Supported options are "exp" (Exponential), "sph" (Spherical), and "gau" (Gaussian). The appropriate model should be selected based on the spatial structure of the data.

* `nugget`: The nugget effect of the variogram, representing measurement error or microscale variation.

* `sill`: The sill of the variogram, indicating the plateau value of the semivariance.

* `range`: The range (or effective range) of the variogram, representing the distance beyond which spatial correlation becomes negligible.

A recommended tool for variogram modeling is the **gstat** package, which provides a robust suite of functions for fitting and analyzing variograms.

### Optional Parameters

* `nhmax`: Maximum number of nearby hard data points to include in the integration process.

* `nsmax`: Maximum number of nearby soft-interval data points to include in the integration process.

* `zk_range`: A numeric vector specifying the range over which to evaluate the unobserved value at the estimation location.

* `n`: An integer indicating the number of points at which to evaluate the posterior density over `zk_range`.

The optional parameters are set to their default values. For further details, refer to the function documentation (e.g., ?`prob_zk`).

### BME Prediction

Using the `utsnowload` dataset, you can prepare the necessary input variables as shown below. In this example, we designate **Locations 1 to 5** as the **prediction locations**.

```{r}
# prediction location
x <- data.matrix(utsnowload[1:5, c("latitude", "longitude")])
x
```

The hard and soft-interval data are assigned as

```{r}
# hard data locations
ch <- data.matrix(utsnowload[6:20, c("latitude", "longitude")]) 

# soft data locations
cs <- data.matrix(utsnowload[68:232, c("latitude", "longitude")])  

# hard data values
zh <- c(utsnowload[6:20, c("hard")])

# lower bounds
a <- c(utsnowload[68:232, c("lower")]) 

# upper bounds
b <- c(utsnowload[68:232, c("upper")]) 

```


The variogram model and parameters are given as:

```{r}
# variogram model and parameters
model <- "exp"
nugget <- 0.0953
sill <- 0.3639
range <- 1.0787
```



The `prob_zk` function accepts all the data and variogram input arguments explained above. The numerical estimation of the posterior density for prediction location is computed as

```{r fig.width = 6, fig.height = 6, fig.align='center'}
prob_zk(x[1,], ch, cs, zh, a, b, model, nugget, sill, range, n = 20, plot = TRUE)
```

The plot of the posterior density becomes smoother as the value of `n` increases.

The `bme_predict` function accepts the same arguments as the `prob_zk` function, with the addition of a `type` argument, which specifies the preferred type of prediction (either the posterior mean or mode). Using the data provided, we can predict the mean and mode of the posterior density at the prediction location location by:

```{r}
# posterior mode
bme_predict(x, ch, cs, zh, a, b, model, nugget, sill, range, type = "mode")

# posterior mean
bme_predict(x, ch, cs, zh, a, b, model, nugget, sill, range, type = "mean")
```


### Leave-One-Out Cross-Validation (LOOCV) for Model Evaluation

LOOCV is used to assess prediction accuracy by successively removing one hard data point at a time—where true values are known—and predicting its value using the remaining hard data and all of the soft-interval data. A variogram model is fitted to the reduced dataset, and the predicted value at the excluded location is compared to its observed value. Soft data locations are excluded from the validation set, as their true values are unobservable.

The `bme_cv` function performs LOOCV for at hard data locations and returns key performance metrics, including **mean error (ME)**, **mean absolute error (MAE)**, and **root mean squared error (RMSE)** of the prediction residuals. These statistics offer insight into the model’s bias, average prediction accuracy, and the variability of prediction errors, respectively.

Functionally, `bme_cv` accepts similar arguments as the `bme_predict` function. Given the necessary data inputs and variogram parameters, LOOCV can be applied to evaluate the posterior mean predictions as follows:

```{r}
bme_cv(ch, cs, zh, a, b, model, nugget, sill, range, type = "mean")

```



